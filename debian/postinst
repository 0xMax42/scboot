#!/bin/sh
set -e

# === Post-install script for scboot ===
# This script creates symlinks for GRUB/kernel resign hooks and
# sets DKMS framework configuration for Secure Boot integration.

# --- Create symlinks for resign scripts ---
# These are user-invokable scripts to manually resign GRUB and kernel images

rm -f /usr/local/sbin/resign-grub
ln -sf /opt/scboot/resign-grub.sh /usr/local/sbin/resign-grub

rm -f /usr/local/sbin/resign-kernel
ln -sf /opt/scboot/resign-kernel.sh /usr/local/sbin/resign-kernel

# --- Create APT hook symlinks ---
# These hooks ensure GRUB and kernel images are automatically re-signed
# after package updates via APT.

rm -f /etc/apt/apt.conf.d/99secureboot-grub-resign
ln -sf /opt/scboot/hooks/apt-secureboot-grub-resign /etc/apt/apt.conf.d/99secureboot-grub-resign

rm -f /etc/apt/apt.conf.d/99secureboot-kernel-resign
ln -sf /opt/scboot/hooks/apt-secureboot-kernel-resign /etc/apt/apt.conf.d/99secureboot-kernel-resign

# --- Update DKMS framework configuration ---
# This enables automatic signing of DKMS modules with the provided Secure Boot key.

CONF="/etc/dkms/framework.conf"

# Ensure the config file exists
if [ ! -f "$CONF" ]; then
    touch "$CONF"
fi

# Remove existing scboot block if present
sed -i '/^# BEGIN scboot/,/^# END scboot/d' "$CONF"

# Append fresh configuration block for scboot
cat >> "$CONF" <<EOF
# BEGIN scboot
sign_kernel_modules="yes"
mok_signing_key="/etc/scboot/keys/DB.key"
mok_certificate="/etc/scboot/keys/DB.der"
# END scboot
EOF
